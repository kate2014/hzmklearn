!function(t){t._({"~name":"seller.goods","~superclass":t.base,"~synthesize":["skuItems","cQ"],"+cls_btn_disable":"ui-button-ldisable","+cls_btn_sDisable":"ui-button-sdisable","+WTH":"wth_","+FKU":"fku_","+skuSelector":"input[name=origin_price],input[name=price],input[name=num],input[name=barcode]","+i_loading":'<span class="uploadify-progress"><span class="uploadify-progress-bar">1</span></span>',"+comonUploadPlaceholder":'<span class="uploadify-button-text"><i class="iconfont">󰃷</i>添加图片</span>',"+nlsMap":{origin_price:"原价",price:"特卖价格",num:"库存",barcode:"条形码"},"+require":".require","+cls_active":"active","+r_i_sku":"颜色","+no_sku_tip":'<p class="note" style="display: block;">暂无SKU信息，请选择销售属性</p>',"+tips":'<p class="note" style="display: block;" cb-node="tips">请先选择图片属性</p>',currentSelection:[],selectedCID:null,selected:!1,_addtionalPropData:null,_skuData:null,skuCollection:[],skuItems:[],skuHepler:!1,editor:null,descripts:{description:"",m_description:""},is_description:!0,uploadPluginForEditor:null,gId:"",batchTempData:[],cQ:{},colors:null,postData:{name:!1,sub_name:!1,cate_id:!1,brief:!1,description:!1,m_description:!1,gallery:[],props:[],sku_props:[],skus:[]},commonGallery:[],ctor:function(t){this.api="goods",this._super(t),cobra.aspect.before($.fn,"addClass",this._resetState),this.watch("currentSelection",this.updateCategorySelection),this._cQ={};var i=window._Global||{};i&&"template"==i.type&&(this.omitSku=!0,this.hasTemplateName=!0,this.pageTemplate=!0)},postCreate:function(){var t=this;this.tplId=this.getQuery("template_id"),this.gId=this.getQuery("id"),this.isEdit=this.tplId||this.gId,this.addFromTpl=!this.pageTemplate&&this.tplId,this.mId=this.getQuery("modify")||0,this.draftId=this.getQuery("draftId"),this.fromDraft=this.draftId&&""!=this.draftId?!0:!1,this.gId&&""!=this.gId&&this.$.saveTemplate.show(),this.fromDraft&&(this.gId="setfalse"),this.compile(this.$.commonImageUploadView,"goods>commonImageUpload",[0,1,2,3],"append"),this.uploadifyConf={file_types:"*.jpg;*.png",file_types_description:"图像文件 (*.jpg,*.png)",buttonClass:"upload-img",trigger:".upload-img",buttonText:'<span class="uploadify-button-text"><i class="iconfont">󰃷</i>添加图片<span class="uploadify-button-skunote">${name}：${color}</span></span>',onUploadStart:function(){t._imgWrapper=this.currentTrigger.find(".uploadify-button-text"),t._imgWrapper.removeClass("hasImg"),t._imageTempStore=t._imgWrapper.html(),t._tSpan=t._imgWrapper.find("span").prop("class","uploadify-button-skunote"),t._imgWrapper.html(""),t._ps=$(seller.goods.i_loading),t._imgWrapper.append(t._ps),t._imgWrapper.append(t._tSpan)},onUploadError:function(){t._imgWrapper&&t._imgWrapper.html(t._imageTempStore),t._ps&&t._ps.remove(),t._msgBox.warn(" 上传失败，请重试!"),delete t._imgWrapper,delete t._imageTempStore,delete t._tSpan},onUploadProgress:function(i){i&&t._ps.find("span.uploadify-progress-bar").css("width",i+"%").html(i+"%")},onUploadSuccess:function(i){if(1e4==i.code){var e=i.data.thumb,s=i.data.url;t._ps.find("span.uploadify-progress-bar").css("width","100%").html("100%"),t._ps.remove(),t._imgWrapper.addClass("hasImg"),t._tSpan.prop("class","uploadify-button-imgnote");var a=this.currentTrigger.parent(),o=a.attr("cb-name"),n=a.attr("cb-id"),r=a.attr("cb-index");if("common"!=this.currentTrigger.attr("data-type"))t._imgWrapper.append('<img src="'+e+'" />'),t._updateGallery({color:t.getReal(t.agumentId(n,r),o),img:s,id:n},r);else{t._imgWrapper.html('<img src="'+e+'" />');var h=Number(a.attr("cb-index"));t.commonGallery[h]={color:"通用",img:s,id:0};var d=this.currentTrigger.siblings(".cancel-common-upload");d.show()}}else t._imageWrapper.html(t._imageTempStore),t._msgBox.warn(" 上传失败，请重试!");delete t._imgWrapper,delete t._imageTempStore,delete t._tSpan}};{var i=window.lib||{};i.imgUpload&&new i.imgUpload(this.uploadifyConf)}if(this.addCancelCommonUpload(),this.isEdit){this.cbs=!0;var e=function(){return t.request(t.fromDraft?"getDraftProductInfo":t.tplId?"getTplInfo":"getProductInfo")};$.when(e(),this.request("brand_list"),this.request("getCategory")).done(cobra.ride(this,function(t){this.selectedCID=t.data.cate_id||0,this.request("getProperty"),0==this.mId&&this.setSelection(t.data.parents,t.data.cate_name)})),this.$.loading.show(),this.$.productDetailPage.show(),this.$.selectionPage.hide(),this.$.reSelectBtn&&1==this.mId&&this.$.reSelectBtn.hide(),1==this.mId&&(this.$.productionTitleForm.find(">fieldset").prop("disabled","disabled"),this.$.productionKeyForm.find(">fieldset").prop("disabled","disabled"),this.$.addtionalInfo.prop("disabled","disabled"),this.$.salesDetail.prop("disabled","disabled"),cobra.ie&&(this.$.productionTitleForm.find("input").prop("disabled","disabled"),this.$.productionKeyForm.find("input").prop("disabled","disabled"),this.$.addtionalInfo.find("input").prop("disabled","disabled"),this.$.productionTitleForm.find("textarea").prop("disabled","disabled"),this.$.productionKeyForm.find("textarea").prop("disabled","disabled"),this.$.addtionalInfo.find("textarea").prop("disabled","disabled")))}else this.request("getCategory"),this.$.selectionPage.show(),this.$.productDetailPage.hide();if(0==this.mId){this.editor=UE.getEditor("editor"),window.ueEditor=this.editor;var s=new $.Deferred;this.editor.ready(cobra.ride(this,function(t){s.resolve(t)})),$.when(s).done(cobra.ride(this,function(){this.isEdit||this.editor.setContent("")}))}},getProductInfoArgs:function(){var t=this.gId;return{type:"get",data:{item_id:t},done:function(){},fail:function(){}}},getDraftProductInfoArgs:function(){var t=this.draftId;return{type:"get",data:{id:t},done:function(){},fail:function(){}}},getTplInfoArgs:function(){return{type:"get",data:{template_id:this.tplId},done:function(){},fail:function(){}}},getCategoryArgs:function(){return{type:"get",done:function(){""==this.gId&&this._showCategory(null,1)}}},getPropertyArgs:function(){var t=this.selectedCID;return{type:"get",data:{category_id:t},done:function(t){this.ModCorner=new cobra.ModCorner({trigger:".j-add-corner",cancel:".j-del-corner",onSelect:function(t){var i=$("#corner-box"),e=$("[cb-node=corner_icon]"),s=i.find(".thumb-box");s.find("img").attr("src",t.thumb),s.show(),i.find(".holder-box").hide(),e.val(t.id)},onCancel:function(){var t=$("#corner-box"),i=$("[cb-node=corner_icon]"),e=t.find(".thumb-box");e.find("img").attr("src",""),t.find(".thumb-box").hide(),t.find(".holder-box").show(),i.val("")}},this),this._renderAdditionalProperties(t),this.fromDraft&&this.fromGoNext&&this.renderProductInfo()}}},_getIndexFromGallery:function(t,i){var e=-1;return $.each(this.postData.gallery,cobra.ride(this,function(t,s){return"undefined"!=typeof i&&s.id==i?(e=t,!1):void 0})),e},_updateGallery:function(t){var i;-1==(i=this._getIndexFromGallery(t.color,t.id))?this.postData.gallery.push(t):this.postData.gallery[i]=t},_renderAdditionalProperties:function(t){this.postData={name:!1,sub_name:!1,cate_id:!1,brief:!1,description:!1,m_description:!1,gallery:[],props:[],sku_props:[],skus:[]},this._skuData=$.grep(t.data,function(t){return 1==t.is_sku})||[],this._addtionalPropData=$.grep(t.data,function(t){return 0==t.is_sku})||[],this.gId||this.addFromTpl?this.renderProductInfo():this.tplId?this.renderTemplateInfo():this._renderAP()},_renderAP:function(t){var i=new $.Deferred;cobra.use(["color/colors"],function(t){i.resolve(t)}),$.when(i).done(cobra.ride(this,function(i){this.colors=i,this.$.selectionPage.hide(),this.$.productDetailPage.show(),$.when(this.compile(this.$.addtionalInfo,"goods>addtionalPI",{data:this._addtionalPropData}),this.compile(this.$.salesDetail,"goods>salesProps",$.extend({data:this._skuData},{colors:i}))).done(cobra.ride(this,function(){this._skuData&&0!=this._skuData.length||this.$.skuHelper.html(seller.goods.no_sku_tip),$.isFunction(t)?t.apply(this,[]):$.isArray(t)&&$.each(t,cobra.ride(this,function(t,i){$.isFunction(i)&&i.apply(this,[])}))}))}))},_renderTemplateAttrs:function(t){this.$.selectionPage.hide(),this.$.productDetailPage.show(),$.when(this.compile(this.$.addtionalInfo,"goods>addtionalPI",{data:this._addtionalPropData})).done(cobra.ride(this,function(){$.each(t,cobra.ride(this,function(t,i){$.isFunction(i)&&i.apply(this,[])}))}))},brand_listArgs:function(){return{type:"get"}},_filterCategory:function(t,i){var e=this.req.getCategory,s={},a=this;return s.data=$.grep(e.data,function(e){return null!=i?i==e.parent_id&&e.cate_level==t:e.cate_level==t}),$.each(s.data,function(){this.hasChildren=a._checkHasChildren(this,e.data)?1:0}),s.data.length>0?s:!1},_checkHasChildren:function(t,i){var e=$.grep(i,function(i){return i.level==t.level-0+1&&i.pid==t.id});return!!e.length},setSelection:function(t,i){return t&&i?void this._showCategory(null,1,null,null,cobra.ride(this,function(t,i){i=i.split("-"),$.each(t,cobra.ride(this,function(t,e){this._showCategory(e,t+2,$.trim(i[t]),this.$["cs_"+e])}))}),[t,i]):void this._showCategory(null,1)},_showCategory:function(t,i,e,s,a,o){s&&s.addClass(seller.goods.cls_active);var n=this._filterCategory(i,t),r=this.$.categoryListView.children();r.size()>1&&$.each(r,cobra.ride(this,function(t,e){t>=i-0-1&&($(e).remove(),this.currentSelection.shift())})),e&&this.set("currentSelection",{level:i-0-1,name:e}),n?(this.selected=!1,this.$.goNext.hasClass(seller.goods.cls_btn_disable)||(this.$.goNext.addClass(seller.goods.cls_btn_disable),this.$.goNext.html("请选择类目")),$.when(this.compile(this.$.categoryListView,"goods>category",n,"append")).done(cobra.ride(this,function(){$.isFunction(a)&&a.apply(this,o||[])}))):(this.$.goNext.removeClass(seller.goods.cls_btn_disable),this.$.goNext.html(this.pageTemplate?"在此类目中添加模板":"在此类目中添加商品"),this.selectedCID=t,this.selected=!0)},_resetState:function(){this.prevAll().removeClass(seller.goods.cls_active),this.nextAll().removeClass(seller.goods.cls_active)},update:function(){arguments[0]},_setCurrentSelection:function(t){this.currentSelection[t.level-1]=t.name},updateCategorySelection:function(){this.$.categorySelection.html(this.currentSelection.join(" - ").replace(/\s*-\s*$/,""))},backToSelection:function(){this.isEdit?miniDialog.confirm("重新选择类目会重新初始化<strong>销售属性、商品图片、SKU信息</strong>, 是否继续?",cobra.ride(this,function(){this.cbs=this.fromDraft?!0:!1,cobra.ie&&(this.$.skuImageUploadView[0].innerHTML=""),this._bs(),this.postData.gallery=[]}),cobra.noop,{title:"温馨提醒",width:300,height:150,closeX:!0}):this._bs()},_bs:function(){this.$.selectionPage.show(),this.$.productDetailPage.hide(),this._skuData=null,this.skuHepler=!1,this.skuCollection=[],this._cQ={},this.$.skuImageUploadView.html(seller.goods.tips),this.$.skuEditorHelper&&this.$.skuEditorHelper.remove(),this.$.skuHelper.html(seller.goods.no_sku_tip),!this.isEdit&&this.editor.setContent(""),this.$.batchEditor.addClass(seller.goods.cls_btn_sDisable),this.batchTempData=[]},goNext:function(){return!arguments[1].hasClass(seller.goods.cls_btn_disable)&&this.selectedCID&&this.selected?(this.$.cate_name.html(this.$.categorySelection.html()),this.isEdit||this.set("brand_id~tmpl#goods>brandList","brand_list"),this.fromGoNext=!0,void this.request("getProperty")):void this._msgBox.info("请选择类目!")},doSku:function(t,i,e,s,a){var o=a.prop("checked"),n={id:e,name:i,vn:this.getReal(this.agumentId(e,s),i),i:s},r=!1;if(0==s&&this.skuCollection[s]&&this.skuCollection[s].val&&20==this.skuCollection[s].val.length?r=20:0!=s&&this.skuCollection[s]&&this.skuCollection[s].val&&15==this.skuCollection[s].val.length&&(r=15),r!==!1)return this._msgBox.warn(t+"最多只能选"+r+"个，已超出限制!"),void a.prop("checked","");if(o)this.skuCollection[s]||(this.skuCollection[s]={name:t,val:[]}),0==s&&(this.$.tips.hide(),this.compile(this.$.skuImageUploadView,"goods>skuImageUpload",{id:"SWF_"+e,color:i,rId:e,i:s},"append").done(cobra.ride(this,function(a){var o=this.parse(this.uploadifyConf.buttonText,{color:this.getReal(this.agumentId(e,s),i),name:t},null,null);this.$["SWF_"+e+"_uploadify"].html(o),this.publish("imageUploadView/"+e,a)}))),this.skuCollection[s].val.push(n),this.$[seller.goods.WTH+e]&&this.$[seller.goods.WTH+e].css("display","inline-block");else{if(this.skuCollection[s]){var h=this._inItems(this.skuCollection[s].val,n);h>-1&&this.skuCollection[s].val.splice(h,1),0==this.skuCollection[s].val.length&&(this.skuCollection[s]=void 0)}if(0==s&&this.$["SWF_"+e]){cobra.ie&&(this.$["SWF_"+e][0].innerHTML=""),this.$["SWF_"+e].remove();var d=this._getIndexFromGallery(i,e);d>-1&&this.postData.gallery.splice(d,1)}this.$[seller.goods.WTH+e]&&this.$[seller.goods.WTH+e].hide()}this.skuHepler&&(this.skuItems={idx:s,action:o?"add":"del",name:t,val:n},cobra.observe.notify("skuItems",this)),this.renderSkuHelper(s,t)},_inItems:function(t,i){var e=-1;return $.each(t,cobra.ride(this,function(t,s){return s.id==i.id&&s.name==i.name?(e=t,!1):void 0})),e},_getSkuCollectionSize:function(){var t=this,i=0;return $.each(this.skuCollection,function(e){"undefined"!=typeof t.skuCollection[e]&&i++}),i},renderSkuHelper:function(){return this._getSkuCollectionSize(),this._skuData.length!==this._getSkuCollectionSize()?void(this.$.skuEditorHelper&&(this.$.skuEditorHelper.remove(),this.skuHepler=!1,this._skuItems=void 0,this.$.batchEditor.addClass(seller.goods.cls_btn_sDisable))):void this.getTemplate("goods>skuHead",cobra.ride(this,this._buildSku))},_buildSku:function(t){this.skuHepler||(this.$.skuHelper.html(this.doT(t,this.skuCollection)),this.skuHepler=!0,this.compile(this.$.skuBodyHelper,"goods>skuItem",this._combine(this.skuCollection),"append").done(cobra.ride(this,function(t){this._renderFromMSKUS(t)})),this.$.batchEditor.removeClass(seller.goods.cls_btn_sDisable))},_renderFromMSKUS:function(t){$.each(t,cobra.ride(this,function(t){$(seller.goods.skuSelector,this.$[t]).each(cobra.ride(this,function(i,e){var s=$(e).attr("name");("origin_price"==s||"price"==s)&&$(e).inputmask(),""!=this.gId&&this.mSKUS&&(this.$[t]&&this.mSKUS[t]&&$(e).val(this.mSKUS[t][s]),1==this.mId&&"barcode"==s&&$(e).prop("disabled","disabled"))})),this.mSKUS&&this.mSKUS[t]&&delete this.mSKUS[t]}))},_combine:function(t,i){for(var e=[],s=[],a=i?t.length:this.skuCollection.length,o=a-1;o>-1;o--)s.push(t[o]?t[o].val:this.skuCollection[o].val);!function h(t,i,s){if(0==s)return e.push(t);for(var a=0;a<i[s-1].length;a++)h(t.concat(i[s-1][a]),i,s-1)}([],s,s.length);var n={},r=this;return $.each(e,function(t,i){var e="";$.each(i,function(t){e+=r._constructSkuRowId(r._skuData[t].id,r._skuData[t].name,this.id,this.name)}),n[e]=i}),e=null,n},_constructSkuRowId:function(t,i,e,s){return":"+t+":"+i+":"+e+":"+s},_updateSkuHelper:function(t){switch(t){case"add":this.compile(this.$.skuBodyHelper,"goods>skuItem",this._combine(this._skuItems),"append").done(cobra.ride(this,function(t){this._renderFromMSKUS(t)}));break;case"del":$.each(this._combine(this._skuItems),cobra.ride(this,function(t){this.$[t]&&this.$[t].remove()}))}this._skuItems=void 0},setSkuItems:function(t){this._skuItems||(this._skuItems=[]),"object"===$.type(t)?(this._skuItems[t.idx]||(this._skuItems[t.idx]={name:t.name,val:[]}),this._skuItems[t.idx].val.push(t.val),this._updateSkuHelper(t.action)):this._skuItems=void 0},batchEditorSku:function(t,i){(!i.hasClass(seller.goods.cls_btn_sDisable)||this.skuHepler)&&this.getTemplate("goods>batchBox",cobra.ride(this,function(t){var i=this;miniDialog.confirm(this.doT(t,this.skuCollection),cobra.noop,cobra.noop,{title:"批量填充SKU",width:600,height:583,buttons:[{value:"填充",click:function(){var t=i._checkSkuBPVIsChecked();return 0!=t.length?($.each(t,function(){i.$[this+"_skubpv"].addClass("warning")}),i._msgBox.warn(" 销售属性未选择完整!"),!1):void i.batchFill()}},{value:"取消",type:"secondary",click:function(){i.batchTempData=[]}}],closeX:!0}),0==this.mId?(this.$.b_origin_price&&this.$.b_origin_price.inputmask(),this.$.b_price&&this.$.b_price.inputmask()):1==this.mId&&this.$.b_barcode&&this.$.b_barcode.prop("disabled","disabled")}))},_checkSkuBPVIsChecked:function(){var t=[];return $.each(this.skuCollection,cobra.ride(this,function(i,e){this.$[e.name+"_skubpv"].removeClass("warning"),0==this.$[e.name+"_skubpv"].find("input:checked").size()&&t.push(e.name)})),t},checkAllItems:function(t,i){var e=this.$[t+"_skubpv"].find("input"),s=!0;$.each(e,function(){return $(this).prop("checked")?void 0:(s=!1,!1)}),s?e.prop("checked",""):e.prop("checked",!0),$.each(e,cobra.ride(this,function(e,s){var a=$(s);this.tcbCheck(i,t,a.attr("cb-id"),a.attr("cb-name"),$(s))}))},batchFill:function(){var t=this._combine(this.batchTempData,!0);$.each(t,cobra.ride(this,function(t){this._fillItem(this.$[t])})),this.batchTempData=[],this._msgBox.done(" 批量填充成功!")},_fillItem:function(t){var i,e="b_",s={origin_price:[],price:[],num:[],barcode:[]};$.grep(t.find("input"),function(t){s[$(t).attr("name")].push(t)}),$.each(s,cobra.ride(this,function(t,s){i=this.$[e+t].val(),$.each(s,function(){i&&(this.value=i)})}))},tcbCheck:function(t,i,e,s,a){this.batchTempData[t]||(this.batchTempData[t]={name:i,val:[]});var o={id:e,name:s};if(a.prop("checked"))this.batchTempData[t].val.push(o);else{var n=this._inItems(this.batchTempData[t].val,o);n>-1&&this.batchTempData[t].val.splice(n,1),0==this.batchTempData[t].val.length&&(this.batchTempData[t]=void 0)}},showProductionExample:function(){miniDialog.confirm(this.$.itemDetailExampleBox.html(),cobra.noop,cobra.noop,{title:"商品详情模板（图片宽度不超800像素）",width:600,height:360,buttons:[],closeX:!0})},validate:function(){var t,i,e,s,a="",t=this._agumentError(this._formValidate(this.$.productionTitleForm)),i=this._agumentError(this._formValidate(this.$.productionKeyForm)),e=this._agumentError(this._formValidate(this.$.productionAddtionalForm));if(a=t+i+e)return this._msgBox.warn(a),!1;if(this.$.productionSalesForm&&$(".ui-form-required",this.$.productionSalesForm).each(function(){var t=$(this).parent().parent(),i=t.find("input:checked");0==i.size()&&(s="请选择"+t.attr("cb-name"))}),a=this._agumentError(s))return this._msgBox.warn(a),!1;var o=function(){this.postData.skus.length=0;var t=this._combine(this.skuCollection);for(var i in t){var e={prop:[]};$(seller.goods.skuSelector,this.$[i]).each(function(){var t=$(this).attr("name"),i=this.value.replace("￥","").replace(/,/g,"");e[t]=i});var s=this._splitSkuInfo(i),o=0,n=s.length-1,r="";n%4!=0&&(n-=n%4);for(var h=0;n>h;h+=4)e.prop.push({prop_id:s[h+1],prop_name:s[h+2],value_id:s[h+3],value_name:this.getReal(this.agumentId(s[h+3],o++),s[h+4])}),r=s[h+4]+",";s=r.substr(0,s.length-1||0),""==$.trim(e.origin_price)?a+="商品"+s+seller.goods.nlsMap.origin_price+"不能为空!<br/>":0==e.origin_price&&(a+="商品"+s+seller.goods.nlsMap.origin_price+"输入错误，不能为0<br/>"),""==$.trim(e.price)?a+="商品"+s+seller.goods.nlsMap.price+"不能为空!<br/>":0==e.price&&(a+="商品"+s+seller.goods.nlsMap.price+"输入错误，不能为0<br/>"),""==$.trim(e.num)?a+="商品"+s+seller.goods.nlsMap.num+"输入错误，不能为空<br/>":/\d+/g.test(e.num)||(a+="商品"+s+seller.goods.nlsMap.num+"输入错误，必须输入数字<br/>"),$.trim(e.origin_price)&&$.trim(e.price)&&$.trim(e.price)-0>$.trim(e.origin_price)-0&&(a+="商品"+s+seller.goods.nlsMap.price+"不能大于"+seller.goods.nlsMap.origin_price+"!"),e.origin_price*=100,e.price*=100,this.postData.skus.push(e)}return a?(a="SKU信息<br/>"+a,this._msgBox.warn(a),this.postData.skus.length=0,!1):!0};return this.skuCollection.length&&!o.call(this)?!1:(""!=$.trim(this.$.user_min_bought.val())&&$.trim(this.$.user_max_bought.val())&&this.$.user_min_bought.val()-0-(this.$.user_max_bought.val()-0)>0&&(a+="每单最少购买量不能大于商品每单最多购买量!<br/>"),a?(a="商品信息<br/>"+a,this._msgBox.warn(a),!1):""==$.trim(this.editor.getContent())?(a="请填写商品详情!",this._msgBox.warn(a),!1):!0)},_splitSkuInfo:function(t){if(!this.$[t])return[];var i=this.$[t].attr(cobra.base.nodePrefix);return i=i.split(":")},_agumentError:function(t){return t?t+"<br/>":""},_formValidate:function(t){var i="";return $(seller.goods.require,t).each(function(){if($.nodeName(this,"input")||$.nodeName(this,"select")){if(""==$.trim($(this).val()))return i=$(this).parent().find("label").text().replace(/[\*:]/g,"")+"不能为空!",!1;if($(this).hasClass("number")){var t=$.trim($(this).val());if(!$.isNumeric(t))return i=$(this).parent().find("label").text().replace(/[\*:]/g,"")+"需要输入数字!",!1}}else if($.nodeName(this,"ul")&&0==$(this).find("input:checked").size())return i=$(this).parent().find("label.ui-label").text().replace(/[\*:]/g,"")+"不能为空!",!1}),i},validateSave:function(){this.postData.skus.length=0;var t=this._combine(this.skuCollection);for(var i in t){var e={prop:[]};$(seller.goods.skuSelector,this.$[i]).each(function(){var t=$(this).attr("name"),i=this.value.replace("￥","").replace(/,/g,"");e[t]=i});var s=this._splitSkuInfo(i),a=0,o=s.length-1,n="";o%4!=0&&(o-=o%4);for(var r=0;o>r;r+=4)e.prop.push({prop_id:s[r+1],prop_name:s[r+2],value_id:s[r+3],value_name:this.getReal(this.agumentId(s[r+3],a++),s[r+4])}),n=s[r+4]+",";s=n.substr(0,s.length-1||0),this.postData.skus.push(e)}return this.$.name&&""!=this.$.name.val()?!0:(this._msgBox.warn("商品名称不能为空!"),!1)},saveProduct:function(){if(0==this.mId&&this.validateSave())this.save_submitted?this._msgBox.warn("已提交，请不要重新提交!"):(this.save_submitted=!0,this.$.loading.html('<p><i class="iconfont">󰃄</i> 正在提交...请稍候</p>'),this.$.loading.show(),this.setPostData(),this.postData.id=this.gId,this.postData.draftId=this.draftId,""!=this.gId?$.when(this.request("editSaveProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.save_submitted=!1,this.$.loading.hide()})):$.when(this.request("addSaveProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.save_submitted=!1,this.$.loading.hide()})));else if(1==this.mId){var t=this.fromDraft?this.req.getDraftProductInfo:this.req.getProductInfo;if(t=t?t.data:!1){var i=$.extend(!0,{},t);for(var e in i)e in this.postData&&(this.postData[e]=i[e]);this.postData.id=i.id,$.each(this.postData.skus,cobra.ride(this,function(t,i){var e="";$.each(i.prop,cobra.ride(this,function(t,i){var s=this._getOriProp(t,i.value_id)||i.value_name;e+=":"+i.prop_id+":"+i.prop_name+":"+i.value_id+":"+s})),this.$[e]&&(this.postData.skus[t].num=this.$[e].find("input[name=num]").val(),this.postData.skus[t].origin_price=this.$[e].find("input[name=origin_price]").val(),this.postData.skus[t].price=this.$[e].find("input[name=price]").val())})),$.when(this.request("editSaveProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.submitted=!1,this.$.loading.hide();var t=arguments.length;if(3==t&&arguments[2].responseInfo){var i=arguments[2].responseInfo.reasons.code,e=arguments[2].responseInfo.reasons.msg;this._msgBox.warn(e+"("+i+")")}}))}else this._msgBox.error(" 网络繁忙，请稍后重试!")}},editSaveProductArgs:function(){var t=this.postData;return{type:"post",data:JSON.stringify(t),done:function(){this._doneSaveWhenSuccess()}}},addSaveProductArgs:function(){var t=this.postData;return{type:"post",data:JSON.stringify(t),done:function(){this._doneSaveWhenSuccess()}}},_doneSaveWhenSuccess:function(){this.$.loading.hide(),this.save_submitted=!1,miniDialog.alert("商品存入草稿成功!",cobra.ride(this,function(){location.href="goods_item_draft_list.html"}),{title:"保存成功",width:312,height:150})},addProduct:function(){if(0==this.mId&&this.validate())this.submitted?this._msgBox.warn("已提交，请不要重新提交!"):(this.submitted=!0,this.$.loading.html('<p><i class="iconfont">󰃄</i> 正在提交...请稍候</p>'),this.$.loading.show(),this.setPostData(),this.postData.id=this.gId,this.postData.item_id=this.gId,this.postData.draftId=this.draftId,""!=this.gId?$.when(this.request("editProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.submitted=!1,this.$.loading.hide()})):$.when(this.request("addProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.submitted=!1,this.$.loading.hide()})));else if(1==this.mId){var t=this.fromDraft?this.req.getDraftProductInfo:this.req.getProductInfo;if(t=t?t.data:!1){var i=$.extend(!0,{},t);for(var e in i)e in this.postData&&(this.postData[e]=i[e]);this.postData.id=i.id,$.each(this.postData.skus,cobra.ride(this,function(t,i){var e="";$.each(i.prop,cobra.ride(this,function(t,i){var s=this._getOriProp(t,i.value_id)||i.value_name;e+=":"+i.prop_id+":"+i.prop_name+":"+i.value_id+":"+s})),this.$[e]&&(this.postData.skus[t].num=this.$[e].find("input[name=num]").val(),this.postData.skus[t].origin_price=this.$[e].find("input[name=origin_price]").val(),this.postData.skus[t].price=this.$[e].find("input[name=price]").val())})),$.when(this.request("editProduct")).done(cobra.noop).fail(cobra.ride(this,function(){this.submitted=!1,this.$.loading.hide();var t=arguments.length;if(3==t&&arguments[2].responseInfo){var i=arguments[2].responseInfo.reasons.code,e=arguments[2].responseInfo.reasons.msg;this._msgBox.warn(e+"("+i+")")}}))}else this._msgBox.error("网络繁忙，请稍后重试!")}},promptSaveTemplate:function(){var t=this;if(this.validate()){if(window.saveTplPrompt)return void window.saveTplPrompt.show();window.saveTplPrompt=miniDialog.prompt("请输入模板名称","",cobra.noop,cobra.noop,{title:"保存为模板",width:200,height:200,closeX:!0,buttons:[{value:"保存",click:function(i,e){var s=e.$content.find("input.miniDialog_prompt_input").val();return s?(t.templateName=s,void t.saveTemplate()):(t._msgBox.error("请输入模板名称!"),!1)}},{value:"取消",type:"secondary",click:cobra.noop}]},!0)}},saveTemplate:function(){if(this.validate())if(this.submitted)this._msgBox.warn("已提交，请不要重新提交!");else{this.submitted=!0,this.$.loading.html('<p><i class="iconfont">󰃄</i> 正在提交...请稍候</p>'),this.$.loading.show(),this.setPostData();var t=this,i=function(){return t.request(t.templateId?"updateTpl":"addTpl")};$.when(i()).done(cobra.noop).fail(cobra.ride(this,function(){this.submitted=!1,this.$.loading.hide()}))}},addTplArgs:function(){var t={};for(var i in this.postData)t[i]=$.isArray(this.postData[i])?JSON.stringify(this.postData[i]):this.postData[i];return t.template_name=t.template_name||this.templateName||"",{type:"get",data:t,done:function(t){t.data&&t.data.id?(this.submitted=!1,this.$.loading.hide(),this.templateId=t.data.id,this.$.saveTemplate&&this.$.saveTemplate.html("更新模板"),this._msgBox.done("已保存")):this._msgBox.warn("保存失败，请稍后重试")}}},updateTplArgs:function(){var t={};for(var i in this.postData)t[i]=$.isArray(this.postData[i])?JSON.stringify(this.postData[i]):this.postData[i];return t.template_id=this.templateId,t.template_name=t.template_name||this.templateName||"",{type:"get",data:t,done:function(){this.submitted=!1,this.$.loading.hide(),this._msgBox.done("已保存")}}},editProductArgs:function(){var t={};for(var i in this.postData)t[i]=$.isArray(this.postData[i])?JSON.stringify(this.postData[i]):this.postData[i];return{type:"post",data:t,done:function(){this._doneWhenSuccess("edit")}}},addProductArgs:function(){var t={};for(var i in this.postData)t[i]=$.isArray(this.postData[i])?JSON.stringify(this.postData[i]):this.postData[i];return{type:"post",data:t,done:function(){this._doneWhenSuccess("add")}}},_doneWhenSuccess:function(t){this.$.loading.hide(),this.submitted=!1;var i="";i="add"==t?"商品提交成功，待上架!":"edit"==t?"商品修改成功!":"操作成功!",miniDialog.alert(i,cobra.ride(this,function(){location.href="goods_item_list.html"}),{title:"提交成功",width:312,height:150})},setPostData:function(){if(this.postData.cate_id=this.selectedCID,this.postData.name=this.$.name.val(),this.postData.sub_name=this.$.sub_name.val(),this.postData.brief=this.$.brief.val(),this.postData.corner_icon=this.$.corner_icon.val(),this.postData.brand_id=this.$.brand_id.val(),this.postData.user_min_bought=this.$.user_min_bought.val(),this.postData.user_max_bought=this.$.user_max_bought.val(),this.postData.delivery_type=this.$.delivery_type.val(),this._updateAddtionalOrSkuData("props"),!this.omitSku&&this._updateAddtionalOrSkuData("sku_props"),this.hasTemplateName&&(this.postData.template_name=this.$.template_name.val()),this.changePlatform(),this.postData.description=this.descripts.description,this.postData.m_description=this.descripts.m_description,this.commonGallery.length){var t=this;$.each(this.commonGallery,function(i,e){e&&t.postData.gallery.push(e)})}},_updateAddtionalOrSkuData:function(t){this.postData[t].length=0,$.each("props"===t?this._addtionalPropData:"sku_props"===t?this._skuData:[],cobra.ride(this,function(i,e){!function(i){var s=i.$[e.name],a=s.attr("cb-type"),o={vid:[],id:e.id,name:e.name,value:[]};"0"==a?(o.vid.push(0),o.value.push(s.val())):"1"==a?(o.vid.push(s.val()),o.value.push(s.find("option:selected").text())):"2"==a&&$.each(s.find("input:checked"),function(){o.vid.push($(this).val()),o.value.push("sku_props"===t?i.getReal(i.agumentId($(this).val(),$(this).attr("cb-index")),$(this).attr("cb-name")):$(this).attr("cb-name"))}),i.postData[t].push(o)}(this)}))},renderProductInfo:function(){var t,i=[],e=this.req.brand_list;return t=this.fromDraft?this.req.getDraftProductInfo:this.addFromTpl?this.req.getTplInfo:this.req.getProductInfo,t.data&&0==t.data.length&&"setfalse"!=this.gId?(this._msgBox.error(" 找不到该商品!"),void this.$.loading.fadeOut(500,cobra.ride(this,function(){this.$.loading.hide()}))):(this.descripts.description=t.data.description,this.descripts.m_description=t.data.m_description,$.each(t.data,cobra.ride(this,function(s,a){switch(s){case"cate_id":break;case"gallery":var o=$.grep(t.data.gallery,function(t){return 0==t.id})||[];this.renderCommonGallery(o);var n=$.grep(t.data.gallery,function(t){return 0!=t.id})||[];i[1]=function(){this.cbs&&$.each(n,cobra.ride(this,function(t,i){this.subscibe("imageUploadView/"+i.id,cobra.ride(this,function(t){if((t.rId==i.id||i.color==t.color)&&i.img){var e=this.$[t.id].find(".uploadify-button-text").addClass("hasImg"),s=e.find(">span").prop("class","uploadify-button-imgnote");e.html('<img src="'+i.img+'" />'),e.append(s),this._updateGallery(i,0)}}))}))};break;case"props":case"sku_props":i["props"==s?0:3]=function(){$.each(t.data[s],cobra.ride(this,function(t,i){this.$[i.name]&&(1===i.vid.length&&0==i.vid[0]?this.$[i.name].val(i.value[0]):1===i.vid.length&&"props"==s&&$.nodeName(this.$[i.name][0],"select")?this.$[i.name].val(i.vid[0]):!this.cbs||"props"!==s&&"sku_props"!==s||$.each(i.vid,cobra.ride(this,function(t,e){this.$[i.name].find("input[value="+e+"]").prop("checked",!0)}))),this.cbs&&"sku_props"===s&&$.each(i.value,cobra.ride(this,function(e,s){var a=this.$[i.name],o=i.vid[e],n=this._getOriProp(t,o);n&&n!=s&&(this.cQ={id:o,c:s,o:n,wrapper:this.$[seller.goods.WTH+o].siblings(),s:i.name,idx:t,i:-1}),a&&this.doSku(i.name,n||s,o,a.attr("cb-name"),a.find("input[value="+o+"]"))}))}))};break;case"skus":this.cbs&&(this.mSKUS={},$.each(t.data.skus,cobra.ride(this,function(t,i){var e="";$.each(i.prop,cobra.ride(this,function(t,i){var s=this._getOriProp(t,i.value_id)||i.value_name;e+=":"+i.prop_id+":"+i.prop_name+":"+i.value_id+":"+s})),i.origin_price&&(i.origin_price=Number(i.origin_price/100).toFixed(2)),i.price&&(i.price=Number(i.price/100).toFixed(2)),this.mSKUS[e]=i})));break;case"description":this.changePlatform("description");break;case"brand_id":$.when(this.set("brand_id~tmpl#goods>brandList",e)).done(cobra.ride(this,function(){this.$[s].val(a)}));break;case"cate_name":this.$.cate_name.html(this.selectedCID!=t.data.cate_id?this.$.categorySelection.html():a);break;case"corner_icon":a.id&&a.icon_url&&this.ModCorner.select({id:a.id,thumb:a.icon_url});break;default:this.$[s]&&this.$[s].val(a)}})),""!=this.gId&&(i[i.length]=function(){this.skuh||(this.skuh=!0)}),i[i.length]=function(){0==this.selectedCID&&0==this.mId&&($(document.body).animate({scrollTop:"0px"},100),this._msgBox.warn(" 请重新选择商品类目，再进行修改!")),this.$.loading.fadeOut(500,cobra.ride(this,function(){this.$.loading.hide()}))},this._renderAP(i),void(i=null))},renderCommonGallery:function(t){var i=seller.goods.comonUploadPlaceholder,e=this;$.each(t,function(t,s){if(s){var a=e.$["commonImageBox-"+t],o=a.find(".uploadify-button-text");s.img?(o.addClass("hasImg").html('<img src="'+s.img+'" />'),a.find(".cancel-common-upload").show(),e.commonGallery[t]=s):(o.html(i),a.find(".cancel-common-upload").hide(),e.commonGallery[t]=null)}})},addCancelCommonUpload:function(){var t=seller.goods.comonUploadPlaceholder,i=this;$("body").on("click",".cancel-common-upload",function(){var e=$(this),s=e.parent(),a=s.find(".uploadify-button-text"),o=s.attr("cb-index");i.commonGallery[o]=null,a.html(t),e.hide()})},renderTemplateInfo:function(){var t=[],i=this.req.getTplInfo,e=this.req.brand_list;
return i.data&&0==i.data.length?(this._msgBox.error("找不到该模板!"),void this.$.loading.fadeOut(500,cobra.ride(this,function(){this.$.loading.hide()}))):(this.descripts.description=i.data.description,this.templateId=i.data.id,this.descripts.m_description=i.data.m_description,$.each(i.data,cobra.ride(this,function(s,a){switch(s){case"props":t[0]=function(){$.each(i.data[s],cobra.ride(this,function(t,i){this.$[i.name]&&(1===i.vid.length&&0==i.vid[0]?this.$[i.name].val(i.value[0]):1===i.vid.length&&"props"==s&&$.nodeName(this.$[i.name][0],"select")?this.$[i.name].val(i.vid[0]):!this.cbs||"props"!==s&&"sku_props"!==s||$.each(i.vid,cobra.ride(this,function(t,e){this.$[i.name].find("input[value="+e+"]").prop("checked",!0)})))}))};break;case"description":this.changePlatform("description");break;case"brand_id":$.when(this.set("brand_id~tmpl#goods>brandList",e)).done(cobra.ride(this,function(){this.$[s].val(a)}));break;case"cate_name":this.$.cate_name.html(this.selectedCID!=i.data.cate_id?this.$.categorySelection.html():a);break;default:this.$[s]&&this.$[s].val(a)}})),t[t.length]=function(){0==this.selectedCID&&0==this.mId&&($(document.body).animate({scrollTop:"0px"},100),this._msgBox.warn(" 请重新选择商品类目，再进行修改!")),this.$.loading.fadeOut(500,cobra.ride(this,function(){this.$.loading.hide()}))},this._renderTemplateAttrs(t),void(t=null))},changePlatform:function(t,i){switch(i&&i.addClass("on")&&i.siblings().removeClass("on"),t){case"description":0==this.mId?this.editor.ready(cobra.ride(this,function(){this.editor.setContent(this.descripts[t]||"")})):1==this.mId&&this.$.editor&&(this.$.editor.html('<div style="width: 708px;height: 500px;overflow: auto;">'+(this.descripts[t]||"")+"</div>"),this.$.editor.css("overflow","inherit"),this.$.editor.show()),this.is_description=!0;break;case"m_description":0==this.mId?this.editor.ready(cobra.ride(this,function(){this.editor.setContent(this.descripts[t]||"")})):1==this.mId&&this.$.editor&&(this.$.editor.html('<div style="width: 708px;height: 500px;overflow: auto;">'+(this.descripts[t]||"")+"</div>"),this.$.editor.css("overflow","inherit"),this.$.editor.show()),this.is_description=!1}try{this.is_description?0==this.mId&&(this.descripts.description=this.editor.getContent()):0==this.mId&&(this.descripts.m_description=this.editor.getContent())}catch(e){console.log(e)}},unlockSkuView:function(){var t=this;miniDialog.confirm(this.$.lockTips.html(),cobra.noop,cobra.noop,{title:"友情提醒：",width:500,height:180,buttons:[{value:"解锁",click:function(){t._unlock()}},{value:"取消",type:"secondary",click:function(){t.batchTempData=[]}}],closeX:!0})},_unlock:function(){this.$.skuView.find(">div.lock-info").remove(),this.$.salesDetail.removeClass("disabled").prop("disabled","")},customize:function(t,i,e,s,a){if(1!=this.mId){if(this.$.salesDetail.hasClass("disabled"))return void this._msgBox.info(" 请先解锁销售属性才可以进行自定义!");var o={p:t,n:this.getReal(this.agumentId(e,s),i),i:e,rn:i};this.getTemplate("goods>customizeTpl",cobra.ride(this,function(n){miniDialog.confirm(this.doT(n,o),cobra.noop,cobra.noop,{title:"自定义销售属性",width:600,height:270,buttons:[{value:"保存",click:cobra.ride(this,function(){if(this.$[seller.goods.FKU+e]){var o=this.$[seller.goods.FKU+e].val();if(o&&o.length>30)return this._msgBox.warn("自定义属性长度超过30个字符!"),!1;if(/[\s:]+/g.test(o))return this._msgBox.warn("自定义属性包含空格或者:, 请修改后重试!"),!1;o=$.trim(o);var n=a.siblings(),r=this._inItems(this.skuCollection[s].val,{id:e,name:i,vn:o});this.cQ={id:e,c:o,o:i,wrapper:n,s:t,idx:s,i:r},cobra.observe.notify("cQ",this)}})},{value:"取消",type:"secondary",click:function(){}}],closeX:!0})}))}},reset:function(t,i){i.siblings().val(t)},getReal:function(t,i){return this._cQ[t]?this._cQ[t].c||this._cQ[t].o||i:i},setCQ:function(t){this._cQ||(this._cQ={});var i=this.agumentId(t.id,t.idx);if(this._cQ[i]={o:t.o,c:t.c},t.wrapper&&t.wrapper.find(">span").html(t.c),this.$["SWF_"+t.id]&&this.$["SWF_"+t.id].find("span.uploadify-button-text>span").html(t.s+"："+t.c),t.i>-1&&this.skuCollection[t.idx]){this.skuCollection[t.idx].val[t.i].vn=t.c;var e={id:this.skuCollection[t.idx].val[t.i].id,name:this.skuCollection[t.idx].val[t.i].name,vn:t.c},s=[];s[t.idx]={name:t.s,val:[]},s[t.idx].val.push(e),$.each(this._combine(s),cobra.ride(this,function(i){this.$[i]&&this.$[i].find("td[cb-id="+t.id+"]").html(t.c)}))}var a=-1;(a=this._getIndexFromGallery(t.o,t.id))>-1&&(this.postData.gallery[a].color=t.c)},agumentId:function(t,i){return t+"_"+i},_getOriProp:function(t,i){if(!(this._skuData&&this._skuData[t]&&this._skuData[t].prop_values&&this._skuData[t].prop_values.vid))return null;var e=-1;return $.each(this._skuData[t].prop_values.vid,function(t,s){return s==i?(e=t,!1):void 0}),-1===e?null:this._skuData[t].prop_values.value[e]}}),$(function(){window.louis=new seller.goods})}(cobra);